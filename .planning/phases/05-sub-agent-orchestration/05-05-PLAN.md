---
phase: 05-sub-agent-orchestration
plan: 05
type: execute
wave: 5
depends_on: ["05-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "cargo build --release succeeds with no errors"
    - "cargo test passes all unit tests"
    - "The TUI renders the sub-agent panel with tree widget (no placeholder)"
    - "The harness starts and shuts down cleanly with no orphan processes"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete sub-agent orchestration system compiles, tests pass, and the TUI renders correctly.

Purpose: Final build and verification before marking Phase 5 complete. This validates that all four prior plans integrate cleanly: types, spawners, tool dispatch, and TUI/wiring.

Output: Confirmed working build, all tests passing, visual verification of TUI sub-agent panel.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sub-agent-orchestration/05-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Full build and test verification</name>
  <files></files>
  <action>
1. Run `cargo build --release` and confirm it succeeds with no errors. Warnings are acceptable but note them.

2. Run `cargo test` and confirm all tests pass. Record the count of tests and any skipped/ignored tests.

3. Run `cargo clippy -- -D warnings` (if clippy is available) and note any issues.

4. Verify no orphan "Phase 5" placeholder text remains:
   - `grep -r "Phase 5" src/` should return no matches
   - `grep -r "placeholder" src/tui/tabs/agent_tab.rs` should return no matches

5. Verify the orchestration module structure:
   - `src/orchestration/mod.rs` exists and exports types, manager, llm_agent, background_proc
   - `src/orchestration/types.rs` exports all type definitions
   - `src/orchestration/manager.rs` exports SubAgentManager
   - `src/orchestration/llm_agent.rs` exports spawn_llm_sub_agent
   - `src/orchestration/background_proc.rs` exports spawn_background_process

6. Verify tool count: `define_tools(None)` should return 9 tools (3 original + 6 new).

7. Verify Cargo.toml has tokio-util and uuid dependencies.
  </action>
  <verify>
    `cargo build --release` exits 0. `cargo test` exits 0 with all tests passing.
  </verify>
  <done>The project builds, all tests pass, no placeholder remnants, orchestration module is structurally complete.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete sub-agent orchestration system:
    - SubAgentManager with hierarchical lifecycle tracking
    - LLM sub-agent spawning (reuses existing agent loop)
    - Background process spawning with stdin/stdout capture
    - Six new agent tools (spawn_llm_session, spawn_background_task, agent_status, agent_result, kill_agent, write_stdin)
    - TUI sub-agent tree panel replacing Phase 5 placeholder
    - Harness-level shutdown with CancellationToken cascade
  </what-built>
  <how-to-verify>
    1. Run `cargo run -- run --headless -m YOUR_MODEL -w /tmp/ouro-test` (replace YOUR_MODEL with an available Ollama model)
    2. Verify the agent starts without errors (the sub-agent tools appear in the system prompt)
    3. Press Ctrl+C to verify clean shutdown (no orphan processes: `ps aux | grep ouro` should show nothing)
    4. Run `cargo run -- run -m YOUR_MODEL -w /tmp/ouro-test` (TUI mode)
    5. Verify the sub-agent panel at the bottom of the Agent tab shows "(No sub-agents running)" instead of the old "(No sub-agents -- Phase 5)" placeholder
    6. Verify the TUI starts and renders without visual glitches
    7. Press 'q' twice to quit and verify clean exit
  </how-to-verify>
  <resume-signal>Type "approved" to mark Phase 5 complete, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
- cargo build --release succeeds
- cargo test passes all tests
- No "Phase 5" placeholder text in source code
- TUI renders sub-agent tree panel
- Harness starts and shuts down cleanly
</verification>

<success_criteria>
Phase 5 is verified complete: the orchestration system compiles, tests pass, TUI renders correctly, and the harness handles lifecycle management cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/05-sub-agent-orchestration/05-05-SUMMARY.md`
</output>
