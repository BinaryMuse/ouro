---
phase: 06-extended-tools-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - src/config/schema.rs
  - src/config/merge.rs
  - src/agent/mod.rs
  - src/agent/web_fetch.rs
  - src/agent/web_search.rs
autonomous: true

must_haves:
  truths:
    - "web_fetch module compiles and exposes a public async function that fetches a URL and returns content as markdown or raw HTML"
    - "web_search module compiles and exposes public async functions for DuckDuckGo and Brave search returning structured results"
    - "Config schema includes search and sleep configuration fields with merge/finalize defaults"
  artifacts:
    - path: "src/agent/web_fetch.rs"
      provides: "HTTP fetch with htmd markdown conversion and optional truncation"
      contains: "pub async fn"
    - path: "src/agent/web_search.rs"
      provides: "DuckDuckGo HTML scraping and Brave REST API search providers with rate limiting"
      contains: "pub async fn"
    - path: "src/config/schema.rs"
      provides: "SearchConfig, SleepConfig structs on ConfigFile; search/sleep fields on AppConfig and PartialConfig"
      contains: "SearchConfig"
    - path: "Cargo.toml"
      provides: "htmd and scraper dependencies"
      contains: "htmd"
  key_links:
    - from: "src/agent/web_fetch.rs"
      to: "reqwest + htmd"
      via: "HTTP GET then htmd::convert for HTML-to-markdown"
      pattern: "htmd::convert"
    - from: "src/agent/web_search.rs"
      to: "reqwest + scraper"
      via: "HTTP GET to DDG lite, parse with scraper CSS selectors"
      pattern: "scraper::Html"
    - from: "src/config/schema.rs"
      to: "src/config/merge.rs"
      via: "PartialConfig merge chain and finalize defaults"
      pattern: "ddg_rate_limit_secs"
---

<objective>
Add new Cargo dependencies (htmd, scraper), extend the config schema with search/sleep fields, and create the standalone web_fetch and web_search modules.

Purpose: Provides the foundation modules and configuration that Plans 02-04 build on. Web fetch and search are self-contained async functions not yet wired into tool dispatch.
Output: Two new agent modules (web_fetch.rs, web_search.rs), updated config schema, new Cargo dependencies.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-extended-tools-discovery/06-CONTEXT.md
@.planning/phases/06-extended-tools-discovery/06-RESEARCH.md
@Cargo.toml
@src/config/schema.rs
@src/config/merge.rs
@src/agent/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dependencies and extend config schema</name>
  <files>Cargo.toml, src/config/schema.rs, src/config/merge.rs</files>
  <action>
1. Add to Cargo.toml dependencies:
   ```toml
   htmd = "0.1"
   scraper = "0.22"
   ```

2. In `src/config/schema.rs`:
   - Add `SearchConfig` struct to `ConfigFile`:
     ```rust
     #[derive(Debug, Deserialize)]
     pub struct SearchConfig {
         pub ddg_rate_limit_secs: Option<f64>,
         pub brave_api_key: Option<String>,
         pub brave_rate_limit_secs: Option<f64>,
     }
     ```
   - Add `SleepConfig` struct to `ConfigFile`:
     ```rust
     #[derive(Debug, Deserialize)]
     pub struct SleepConfig {
         pub max_sleep_duration_secs: Option<u64>,
     }
     ```
   - Add `pub search: Option<SearchConfig>` and `pub sleep: Option<SleepConfig>` to `ConfigFile`.
   - Add to `AppConfig`:
     ```rust
     pub ddg_rate_limit_secs: f64,
     pub brave_api_key: Option<String>,
     pub brave_rate_limit_secs: f64,
     pub max_sleep_duration_secs: u64,
     ```
   - Add corresponding `Option` fields to `PartialConfig`:
     ```rust
     pub ddg_rate_limit_secs: Option<f64>,
     pub brave_api_key: Option<Option<String>>,
     pub brave_rate_limit_secs: Option<f64>,
     pub max_sleep_duration_secs: Option<u64>,
     ```
   - Extend `ConfigFile::to_partial()` to map search/sleep sections to PartialConfig fields.

3. In `src/config/merge.rs`:
   - Extend `PartialConfig::with_fallback()` to merge the 4 new fields (same `.or()` pattern).
   - Extend `PartialConfig::finalize()` with defaults:
     - `ddg_rate_limit_secs` -> 2.0
     - `brave_api_key` -> None
     - `brave_rate_limit_secs` -> 1.0
     - `max_sleep_duration_secs` -> 3600

4. Update all existing `AppConfig` construction sites in tests (search for `AppConfig {` in tools.rs tests and any other test files) to include the 4 new fields with their defaults.

Note: Do NOT add `#[derive(Default)]` to AppConfig -- existing tests construct it explicitly.
  </action>
  <verify>
`cargo check` passes with the new dependencies resolved and config fields compiling.
  </verify>
  <done>
ConfigFile, PartialConfig, and AppConfig all have search/sleep fields. Defaults are 2.0s DDG rate limit, 1.0s Brave rate limit, no Brave API key, 3600s max sleep. htmd and scraper are in Cargo.toml.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create web_fetch and web_search modules</name>
  <files>src/agent/web_fetch.rs, src/agent/web_search.rs, src/agent/mod.rs</files>
  <action>
1. Create `src/agent/web_fetch.rs`:
   - Implement `pub async fn fetch_url(url: &str, format: &str, max_length: Option<usize>) -> String` that:
     - Creates a `reqwest::Client` with 30s timeout, redirect policy limited(10), and user-agent "Mozilla/5.0 (compatible; Ouro/0.1)"
     - Sends HTTP GET to url
     - On non-success status, returns JSON error string `{"error": "web_fetch: HTTP {status}"}`
     - Checks content-type header:
       - If `application/json`: return body as-is (with optional truncation)
       - If `text/html` and format == "markdown": convert body via `htmd::convert(&body).unwrap_or(body)`
       - Otherwise: return body as-is
     - Applies `maybe_truncate` helper for `max_length` parameter
     - On any reqwest error, returns JSON error string
   - Implement `fn maybe_truncate(content: &str, max_length: Option<usize>) -> String` as a helper
   - All errors return JSON error strings (never `Err`), matching the dispatch_tool_call convention

2. Create `src/agent/web_search.rs`:
   - Define `pub struct SearchResult { pub title: String, pub url: String, pub snippet: String }` (derive Debug, Clone, Serialize)
   - Implement `pub async fn search_duckduckgo(query: &str, count: usize) -> String` that:
     - Creates reqwest client with user-agent "Mozilla/5.0 (X11; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0"
     - Sends GET to `https://lite.duckduckgo.com/lite/` with query param `q`
     - Parses HTML with `scraper::Html::parse_document`
     - Extracts result links, titles, and snippets from the DDG lite table layout using CSS selectors
     - Returns JSON array of `SearchResult` objects, truncated to `count`
     - On error, returns JSON error string
   - Implement `pub async fn search_brave(query: &str, count: usize, api_key: &str) -> String` that:
     - Sends GET to `https://api.search.brave.com/res/v1/web/search` with `X-Subscription-Token` header and `q`/`count` params
     - Parses JSON response, extracts `web.results` array
     - Returns JSON array of `SearchResult` objects
     - Handles 401 (bad API key) and 429 (rate limit) with clear error messages
   - Implement rate limiting state:
     - Use `std::sync::Mutex<Option<tokio::time::Instant>>` static or module-level variable for tracking last request time
     - `pub async fn rate_limited_ddg_search(query: &str, count: usize, rate_limit_secs: f64) -> String` -- waits if needed then calls `search_duckduckgo`
     - `pub async fn rate_limited_brave_search(query: &str, count: usize, api_key: &str, rate_limit_secs: f64) -> String` -- waits if needed then calls `search_brave`

3. In `src/agent/mod.rs`, add:
   ```rust
   pub mod web_fetch;
   pub mod web_search;
   ```

Note: These modules are standalone -- no wiring into tools.rs happens in this plan. That's Plan 03.
  </action>
  <verify>
`cargo check` passes. `cargo test` passes (including any unit tests in the new modules and the existing test suite -- particularly tools.rs tests which construct AppConfig and must include new fields).
  </verify>
  <done>
web_fetch.rs exports `fetch_url`. web_search.rs exports `search_duckduckgo`, `search_brave`, and rate-limited wrappers. Both modules are registered in agent/mod.rs. All return JSON strings matching the dispatch convention.
  </done>
</task>

</tasks>

<verification>
1. `cargo check` compiles cleanly with new deps, config fields, and modules
2. `cargo test` passes -- all existing tests (including tools.rs tests with updated AppConfig) still work
3. `src/agent/web_fetch.rs` exists with `pub async fn fetch_url`
4. `src/agent/web_search.rs` exists with `pub async fn search_duckduckgo` and `pub async fn search_brave`
5. `AppConfig` has `ddg_rate_limit_secs`, `brave_api_key`, `brave_rate_limit_secs`, `max_sleep_duration_secs` fields
</verification>

<success_criteria>
- New dependencies compile (htmd 0.1, scraper 0.22)
- Config schema has all 4 new fields with merge and default support
- web_fetch module compiles with reqwest + htmd integration
- web_search module compiles with reqwest + scraper integration
- All existing tests pass with updated AppConfig construction
</success_criteria>

<output>
After completion, create `.planning/phases/06-extended-tools-discovery/06-01-SUMMARY.md`
</output>
