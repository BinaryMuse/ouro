---
phase: 03-context-management-resilience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/schema.rs
  - src/config/merge.rs
  - src/agent/logging.rs
autonomous: true

must_haves:
  truths:
    - "Context management config fields are available in AppConfig at runtime"
    - "New JSONL log entry types serialize correctly for token usage, masking, and restart events"
  artifacts:
    - path: "src/config/schema.rs"
      provides: "AppConfig with soft_threshold_pct, hard_threshold_pct, carryover_turns, max_restarts, auto_restart fields"
      contains: "soft_threshold_pct"
    - path: "src/config/merge.rs"
      provides: "Defaults for all new config fields, PartialConfig merge support"
      contains: "soft_threshold_pct"
    - path: "src/agent/logging.rs"
      provides: "LogEntry::TokenUsage, LogEntry::ContextMask, LogEntry::SessionRestart variants"
      contains: "TokenUsage"
  key_links:
    - from: "src/config/schema.rs"
      to: "src/config/merge.rs"
      via: "PartialConfig fields flow through with_fallback and finalize"
      pattern: "soft_threshold_pct.*or\\("
---

<objective>
Add context management configuration fields to AppConfig and new JSONL log entry types for token tracking, observation masking, and session restart events.

Purpose: Foundation layer that Plan 02 (ContextManager) and Plan 03 (agent loop integration) depend on. Config fields control graduated threshold behavior; log entries enable session replay and future TUI consumption.
Output: Extended AppConfig with 5 new fields, extended LogEntry enum with 3 new variants, all existing tests still passing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/config/schema.rs
@src/config/merge.rs
@src/agent/logging.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add context management config fields</name>
  <files>src/config/schema.rs, src/config/merge.rs</files>
  <action>
In `src/config/schema.rs`:

1. Add a `[context]` section to ConfigFile by creating a new `ContextConfig` struct:
```rust
#[derive(Debug, Deserialize)]
pub struct ContextConfig {
    pub soft_threshold_pct: Option<f64>,
    pub hard_threshold_pct: Option<f64>,
    pub carryover_turns: Option<usize>,
    pub max_restarts: Option<u32>,
    pub auto_restart: Option<bool>,
}
```

2. Add `pub context: Option<ContextConfig>` to `ConfigFile`.

3. Add 5 new fields to `AppConfig`:
   - `pub soft_threshold_pct: f64` (fraction 0.0-1.0, default 0.70)
   - `pub hard_threshold_pct: f64` (fraction 0.0-1.0, default 0.90)
   - `pub carryover_turns: usize` (default 5)
   - `pub max_restarts: Option<u32>` (None = unlimited)
   - `pub auto_restart: bool` (default true)

4. Add the same 5 fields as Options to `PartialConfig`.

5. Extend `ConfigFile::to_partial()` to map the new `context` section fields into PartialConfig.

In `src/config/merge.rs`:

6. Extend `PartialConfig::with_fallback()` to merge the 5 new fields using `.or()` (same pattern as existing fields).

7. Extend `PartialConfig::finalize()` to apply defaults:
   - soft_threshold_pct: 0.70
   - hard_threshold_pct: 0.90
   - carryover_turns: 5
   - max_restarts: None (unlimited)
   - auto_restart: true

8. Add tests:
   - `test_context_config_defaults` -- verify finalize() produces correct defaults
   - `test_context_config_override` -- verify TOML values override defaults
   - `test_context_config_merge_layers` -- verify CLI > workspace > global merge for new fields

Follow the EXACT same patterns as the existing config code (PartialConfig Option fields, .or() merge, .unwrap_or() defaults). Do NOT change any existing field behavior.
  </action>
  <verify>
`cargo test --lib` passes (all existing config tests + new tests).
`cargo check` compiles cleanly with no warnings.
  </verify>
  <done>
AppConfig has 5 new fields with sensible defaults. PartialConfig merges them correctly through the config layering system. Three new tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add new LogEntry variants for context management events</name>
  <files>src/agent/logging.rs</files>
  <action>
Add 3 new variants to the `LogEntry` enum in `src/agent/logging.rs`:

1. `TokenUsage` -- logged after every model response:
```rust
#[serde(rename = "token_usage")]
TokenUsage {
    timestamp: String,
    turn: u64,
    prompt_tokens: usize,
    completion_tokens: usize,
    total_tokens: usize,
    context_used_pct: f64,
}
```

2. `ContextMask` -- logged when observation masking occurs:
```rust
#[serde(rename = "context_mask")]
ContextMask {
    timestamp: String,
    observations_masked: usize,
    total_masked: usize,
    context_reclaimed_pct: f64,
}
```

3. `SessionRestart` -- logged when a session restart occurs:
```rust
#[serde(rename = "session_restart")]
SessionRestart {
    timestamp: String,
    session_number: u32,
    previous_turns: u64,
    carryover_messages: usize,
    reason: String,
}
```

Add tests that verify each new variant serializes to valid JSONL:
- `test_token_usage_event_serialization` -- log a TokenUsage event, read back, verify all fields
- `test_context_mask_event_serialization` -- log a ContextMask event, read back, verify all fields
- `test_session_restart_event_serialization` -- log a SessionRestart event, read back, verify all fields

Follow the EXACT same testing pattern as the existing logging tests (create logger via make_logger(), log event, read lines from file, parse JSON, assert fields).
  </action>
  <verify>
`cargo test --lib` passes (all existing logging tests + 3 new tests).
`cargo check` compiles cleanly.
  </verify>
  <done>
LogEntry enum has 3 new variants. Each serializes to correct JSONL format with event_type tags. All existing tests unaffected.
  </done>
</task>

</tasks>

<verification>
- `cargo check` compiles the full crate with no errors or warnings
- `cargo test` passes all tests (existing + new)
- AppConfig can be constructed with default context management values
- New LogEntry variants produce valid JSON lines with correct event_type tags
</verification>

<success_criteria>
- 5 new AppConfig fields with defaults (0.70, 0.90, 5, None, true)
- PartialConfig layering works for new fields
- 3 new LogEntry variants serialize to JSONL
- All existing tests pass unchanged
- No new dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/03-context-management-resilience/03-01-SUMMARY.md`
</output>
