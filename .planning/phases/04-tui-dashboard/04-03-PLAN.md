---
phase: 04-tui-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/tui/mod.rs
  - src/tui/ui.rs
  - src/tui/tabs/mod.rs
  - src/tui/tabs/agent_tab.rs
  - src/tui/tabs/discoveries_tab.rs
  - src/tui/widgets/mod.rs
  - src/tui/widgets/log_stream.rs
  - src/tui/widgets/status_bar.rs
  - src/tui/widgets/context_gauge.rs
autonomous: true

must_haves:
  truths:
    - "The Agent tab renders a scrollable log of structured entries (thoughts, tool calls, results) with color-coded type indicators and timestamps"
    - "Tool results show a one-line collapsed summary by default with line count"
    - "The Discoveries tab renders a scrollable list of agent-flagged discoveries with timestamps"
    - "The two-line status bar shows agent state, context pressure gauge, session number, turn/tool counters, and keybind hints"
    - "Tab bar at top shows Agent and Discoveries tabs with active tab highlighted"
    - "Bordered panels with title labels provide clear section separation"
  artifacts:
    - path: "src/tui/ui.rs"
      provides: "Top-level render function dispatching to active tab"
      exports: ["render_ui"]
    - path: "src/tui/tabs/agent_tab.rs"
      provides: "Agent tab rendering (log stream + sub-agent tree placeholder)"
      exports: ["render_agent_tab"]
    - path: "src/tui/tabs/discoveries_tab.rs"
      provides: "Discoveries tab rendering (scrollable list)"
      exports: ["render_discoveries_tab"]
    - path: "src/tui/widgets/status_bar.rs"
      provides: "Two-line status bar widget"
      exports: ["render_status_bar"]
    - path: "src/tui/widgets/context_gauge.rs"
      provides: "Context pressure colored gauge"
      exports: ["render_context_gauge"]
    - path: "src/tui/widgets/log_stream.rs"
      provides: "Log entry rendering as structured blocks"
      exports: ["render_log_entries"]
  key_links:
    - from: "src/tui/ui.rs"
      to: "src/tui/app_state.rs"
      via: "render_ui takes &AppState and renders based on active_tab"
      pattern: "fn render_ui.*AppState"
    - from: "src/tui/widgets/status_bar.rs"
      to: "src/tui/event.rs"
      via: "Renders AgentState as colored text in status bar"
      pattern: "AgentState"
---

<objective>
Build all TUI rendering widgets: tab layout, log stream, discoveries list, status bar, and context gauge.

Purpose: This is the visual layer -- all ratatui widget composition and rendering logic. These are pure functions that take AppState and produce rendered frames. No event handling or main loop logic.
Output: Complete rendering code in src/tui/ui.rs, tabs/, and widgets/ that can draw the full TUI from AppState.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-tui-dashboard/04-RESEARCH.md
@.planning/phases/04-tui-dashboard/04-CONTEXT.md
@.planning/phases/04-tui-dashboard/04-01-SUMMARY.md
@src/tui/event.rs
@src/tui/app_state.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create widget modules (log_stream, status_bar, context_gauge)</name>
  <files>src/tui/widgets/mod.rs, src/tui/widgets/log_stream.rs, src/tui/widgets/status_bar.rs, src/tui/widgets/context_gauge.rs</files>
  <action>
**src/tui/widgets/mod.rs:**
```rust
pub mod context_gauge;
pub mod log_stream;
pub mod status_bar;
```

**src/tui/widgets/log_stream.rs** -- Renders log entries as structured visual blocks:

Create `render_log_entries(entries: &[LogEntry], scroll_offset: usize, area: Rect, buf: &mut Buffer)` or equivalent function that returns a widget/renders into a Block.

For each LogEntry, render as:
- Header line: icon/symbol prefix + timestamp + kind label, colored per kind
  - Thought: cyan, prefix symbol (choose a unicode symbol like a thought bubble or simple text marker)
  - ToolCall: yellow, prefix symbol
  - ToolResult: green (or dim if collapsed), prefix symbol
  - Error: red, prefix symbol
  - SessionSeparator: dim horizontal separator line "--- Session N started ---"
  - System: magenta, prefix symbol
- Content area (indented):
  - If expanded: show full_content
  - If collapsed: show summary only (one line)
- Tool results collapsed by default: summary shows e.g. "shell_exec: 42 lines of output"

Use ratatui's Paragraph widget with Line/Span compositing for color-coded text. Create a Vec<Line> from the visible entries (those within scroll_offset..scroll_offset+visible_height) and render as a single Paragraph inside a bordered Block titled "Log".

Add a Scrollbar widget on the right edge for position indication.

**src/tui/widgets/status_bar.rs** -- Two-line persistent status bar:

Create `render_status_bar(state: &AppState, area: Rect, buf: &mut Buffer)` that renders:
- Line 1: Agent state (colored: Thinking=yellow, Executing=cyan, Idle=dim, Paused=red) | context pressure gauge | Session N | Turn N | Tools: N
- Line 2: Keybind hints for current context: "Tab: switch tabs | arrows: scroll | p: pause/resume | e: expand | q: quit"

Use Spans with different styles for each segment. Separate segments with " | " delimiters.

Agent state text should be bold and colored per state.

**src/tui/widgets/context_gauge.rs** -- Context pressure visualization:

Create `render_context_gauge(usage_pct: f64) -> Vec<Span>` that returns styled spans:
- A small text gauge like "[####----] 48%"
- Color: green (0-50%), yellow (50-70%), red (70%+)
- Width: ~15 characters total

Use filled/empty block characters for the bar portion.
  </action>
  <verify>`cargo check` succeeds.</verify>
  <done>All three widget modules compile. log_stream renders color-coded entries with collapse/expand support. status_bar renders two information-dense lines. context_gauge renders a colored progress indicator.</done>
</task>

<task type="auto">
  <name>Task 2: Create tab renderers and top-level UI function</name>
  <files>src/tui/tabs/mod.rs, src/tui/tabs/agent_tab.rs, src/tui/tabs/discoveries_tab.rs, src/tui/ui.rs, src/tui/mod.rs</files>
  <action>
**src/tui/tabs/mod.rs:**
```rust
pub mod agent_tab;
pub mod discoveries_tab;
```

**src/tui/tabs/agent_tab.rs** -- Agent tab (Tab 1):

Create `render_agent_tab(state: &AppState, area: Rect, buf: &mut Buffer)`:
- If sub_agent_panel_visible: split area vertically -- 70% log stream (top), 30% sub-agent tree (bottom)
- If sub_agent_panel_hidden: log stream takes full area
- Render log stream using log_stream::render_log_entries
- Render sub-agent tree as a bordered Block titled "Sub-Agents" with placeholder text "(No sub-agents -- Phase 5)" since sub-agents are Phase 5 work. Use a simple Paragraph inside a bordered block.

**src/tui/tabs/discoveries_tab.rs** -- Discoveries tab (Tab 2):

Create `render_discoveries_tab(state: &AppState, area: Rect, buf: &mut Buffer)`:
- Render discoveries as a scrollable List widget inside a bordered Block titled "Discoveries"
- Each item: "[timestamp] content" -- most recent at top (reverse chronological)
- If no discoveries: show dim text "No discoveries flagged yet"

**src/tui/ui.rs** -- Top-level render function:

Create `render_ui(state: &AppState, frame: &mut Frame)`:

Layout (top to bottom):
1. Tab bar (1 line): Tabs widget with ["Agent", "Discoveries"], active_tab highlighted
2. Content area (remaining - 2 lines): dispatch to active tab renderer
3. Status bar (2 lines): render_status_bar

Use ratatui Layout with Constraint::Length(1) for tab bar, Constraint::Min(0) for content, Constraint::Length(2) for status bar.

Tab bar: use ratatui::widgets::Tabs with titles vec!["Agent", "Discoveries"], highlight_style with bold + underline, select based on state.active_tab.

Content dispatch:
```rust
match state.active_tab {
    0 => agent_tab::render_agent_tab(state, content_area, frame.buffer_mut()),
    1 => discoveries_tab::render_discoveries_tab(state, content_area, frame.buffer_mut()),
    _ => {}
}
```

If quit_pending, overlay a small centered confirmation prompt: "Quit? (y/n)"

**Update src/tui/mod.rs** to include new submodules:
```rust
pub mod app_state;
pub mod event;
pub mod tabs;
pub mod ui;
pub mod widgets;
```
  </action>
  <verify>`cargo check` succeeds. All modules resolve and compile.</verify>
  <done>render_ui dispatches to the correct tab based on active_tab. Agent tab shows log stream with optional sub-agent panel. Discoveries tab shows a scrollable list. Tab bar and status bar frame every view. All rendering is pure -- takes &AppState, produces pixels.</done>
</task>

</tasks>

<verification>
- `cargo check` passes
- All files exist under src/tui/ (ui.rs, tabs/, widgets/)
- render_ui takes &AppState and &mut Frame
- Log entries are color-coded by kind
- Status bar shows all required info (agent state, context gauge, session, turn, tools, keybinds)
- Tab bar shows two tabs
</verification>

<success_criteria>
The full TUI visual layer compiles. render_ui can draw the complete interface from an AppState snapshot. All widgets handle edge cases (empty log, no discoveries, zero context usage). No main loop or event handling -- just pure rendering functions.
</success_criteria>

<output>
After completion, create `.planning/phases/04-tui-dashboard/04-03-SUMMARY.md`
</output>
